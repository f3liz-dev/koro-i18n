// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  output          = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id       String   @id
  githubId Int      @unique
  username String
  email    String
  avatarUrl String?
  githubAccessToken String? // GitHub OAuth token with public_repo scope
  createdAt DateTime @default(now())

  // Relations
  projects              Project[]
  webTranslations       WebTranslation[]
  approvedTranslations  WebTranslation[]      @relation("ApprovedBy")
  webTranslationHistory WebTranslationHistory[]
  projectMemberships    ProjectMember[]
  addedMembers          ProjectMember[] @relation("AddedBy")

  @@index([githubId])
}

// OAuth states table (temporary, auto-expire, in-memory only for stateless JWT)
model OauthState {
  state     String   @id
  timestamp Int
  expiresAt DateTime

  @@index([expiresAt])
}

// Source Keys (synced via koro push)
// This is the Source of Record for keys - stored in D1 for fast access
model SourceKey {
  id          String   @id
  projectId   String
  filename    String   // e.g., "settings/en-US.json"
  key         String   // Flattened key: "header.title"
  value       String   // Source value
  hash        String   // Hash for change detection (16 chars)
  context     String?  // Optional context for translators (future)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@unique([projectId, filename, key])
  @@index([projectId])
  @@index([projectId, filename])
  @@index([hash])
}

// R2 File Index (GitHub imports - mutable, stored in R2)
// This table stores metadata and pointers to R2, not the actual file contents
// Files are OVERWRITTEN on each upload, git history is in the metadata
model R2File {
  id          String   @id
  projectId   String
  branch      String
  commitSha   String   // Latest commit that modified this file
  lang        String
  filename    String
  r2Key       String   // R2 object key: [project]-[lang]-[filename] (no commit hash)
  sourceHash  String   // Hash of source content
  totalKeys   Int      // Total number of translation keys
  approvedCount Int    @default(0)
  committedCount Int   @default(0)
  uploadedAt  DateTime @default(now())
  lastUpdated DateTime @default(now()) @updatedAt // For ETag

  // Deletion state used to coordinate transactional-like cleanup
  // Set to true when a cleanup worker starts deleting the R2 objects so
  // concurrent processes can detect in-progress deletions and avoid races.
  deleting     Boolean  @default(false)

  // Optional misc metadata R2 key stored alongside main r2Key.
  // This allows cleanup and tooling to know the exact misc object name.
  miscR2Key    String?

  @@unique([projectId, branch, lang, filename])
  @@index([projectId, branch])
  @@index([projectId, lang])
  @@index([lastUpdated])
}

// Web Translations (user-submitted translations via web UI)
// GitHub repository is the source of truth - it stores original and translated resources
// This table stores DIFFS only: user suggestions that are pending approval/commit
// These are NOT stored in GitHub until approved and synced by GitHub Actions
model WebTranslation {
  id              String   @id
  projectId       String
  language        String
  filename        String
  key             String   // Flattened key (e.g., "common.welcome")
  value           String
  userId          String
  
  // Workflow: draft (working) -> approved (ready for export)
  status          String   @default("draft") // draft, approved
  
  // Approval tracking
  approvedById    String?  // Who approved (null = self-approved or not yet approved)
  approvedAt      DateTime? // When approved
  
  // Source tracking (for validation)
  sourceHash      String?  // Hash of source value when translated (for detecting changes)
  isValid         Boolean  @default(true) // False if source changed
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  // Relations
  user       User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedBy User?                     @relation("ApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  history    WebTranslationHistory[]

  @@unique([projectId, language, filename, key]) // One translation per key per language
  @@index([projectId, language, filename])
  @@index([status])
  @@index([projectId, language, filename, key])
  @@index([updatedAt])
  @@index([isValid])
  @@index([projectId, language, status, isValid]) // Optimized for counts query
}

// Web Translation History (audit trail for web translations only)
model WebTranslationHistory {
  id            String   @id
  translationId String
  projectId     String
  language      String
  filename      String
  key           String
  value         String
  userId        String
  action        String   // submitted, approved, rejected, deleted, invalidated
  
  // Source tracking at time of action
  sourceHash    String?  // Hash of source value at time of action
  
  createdAt     DateTime @default(now())

  // Relations
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  translation WebTranslation @relation(fields: [translationId], references: [id], onDelete: Cascade)

  @@index([translationId])
  @@index([projectId, language, filename, key])
  @@index([createdAt])
}

// Projects (Cloudflare-style: simple name + repository binding)
model Project {
  id            String   @id
  userId        String
  name          String   @unique
  repository    String   @unique
  accessControl String   @default("whitelist") // 'whitelist' or 'blacklist'
  sourceLanguage String  @default("en") // Source language for translations
  createdAt     DateTime @default(now())

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  members ProjectMember[]

  @@index([userId])
  @@index([name])
  @@index([repository])
}

// Project members (users who have access to a project)
// Crowdin-like 4-tier permission system
model ProjectMember {
  id        String   @id
  projectId String
  userId    String
  status    String   @default("pending") // 'pending', 'approved', 'rejected'
  
  // Role determines permission level:
  // - owner: Full control, can delete project
  // - manager: Manage members, settings, all languages
  // - proofreader: Translate + approve for assigned languages (can self-approve)
  // - translator: Translate only for assigned languages
  role      String   @default("translator")
  
  // Language permissions (JSON array or null for all)
  // Example: ["ja", "ko", "zh-CN"] - only these languages
  // null = all languages (for owner/manager or unrestricted translator)
  languages String?
  
  addedBy   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  // Relations
  project      Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedByUser  User?   @relation("AddedBy", fields: [addedBy], references: [id], onDelete: SetNull)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([projectId, status])
  @@index([projectId, role])
}

