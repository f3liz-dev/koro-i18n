name: 'Download Translations from Koro i18n'
description: 'Download translated files from Koro i18n platform and apply them to your repository'
author: 'Koro i18n'

branding:
  icon: 'download'
  color: 'green'

inputs:
  platform-url:
    description: 'The URL of the i18n platform'
    required: false
    default: 'https://i18n-platform.workers.dev'
  project-name:
    description: 'Project name on the platform'
    required: true
  branch:
    description: 'Branch to download translations from'
    required: false
    default: 'main'
  language:
    description: 'Specific language to download (downloads all if not specified)'
    required: false
  output-dir:
    description: 'Directory to output downloaded translations'
    required: false
    default: 'locales'
  commit-changes:
    description: 'Whether to commit and push changes automatically'
    required: false
    default: 'true'
  commit-message:
    description: 'Commit message for translation updates'
    required: false
    default: 'chore: Update translations from i18n platform'

outputs:
  files-downloaded:
    description: 'Number of files downloaded'
    value: ${{ steps.download.outputs.files-downloaded }}
  languages-updated:
    description: 'Languages that were updated'
    value: ${{ steps.download.outputs.languages-updated }}

runs:
  using: 'composite'
  steps:
    - name: Get OIDC Token
      id: oidc
      shell: bash
      run: |
        OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ inputs.platform-url }}" | jq -r .value)
        echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

    - name: Download translations
      id: download
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        BRANCH: ${{ inputs.branch }}
        LANGUAGE: ${{ inputs.language }}
        OUTPUT_DIR: ${{ inputs.output-dir }}
      run: |
        # Download translations from platform using OIDC token with unflatten option
        DOWNLOAD_URL="$I18N_PLATFORM_URL/api/projects/$PROJECT_NAME/download?branch=$BRANCH&unflatten=true"
        
        if [ -n "$LANGUAGE" ]; then
          DOWNLOAD_URL="$DOWNLOAD_URL&language=$LANGUAGE"
        fi
        
        echo "Downloading from: $DOWNLOAD_URL"
        
        RESPONSE=$(curl -sS -H "Authorization: Bearer $OIDC_TOKEN" "$DOWNLOAD_URL")
        
        # Check if download was successful
        if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
          echo "Error: $(echo "$RESPONSE" | jq -r '.error')"
          exit 1
        fi
        
        echo "Download successful!"
        
        # Create output directory if it doesn't exist
        mkdir -p "$OUTPUT_DIR"
        
        # Parse and write files
        FILE_COUNT=0
        LANGUAGES=""
        
        # Extract files by language
        for lang in $(echo "$RESPONSE" | jq -r '.files | keys[]'); do
          echo "Processing language: $lang"
          LANG_DIR="$OUTPUT_DIR/$lang"
          mkdir -p "$LANG_DIR"
          
          # Get all files for this language
          for filename in $(echo "$RESPONSE" | jq -r ".files[\"$lang\"] | keys[]"); do
            echo "  Writing file: $filename"
            
            # Extract content (already unflattened by the server)
            CONTENT=$(echo "$RESPONSE" | jq -c ".files[\"$lang\"][\"$filename\"]")
            
            # Write the already-unflattened content
            echo "$CONTENT" | jq '.' > "$LANG_DIR/$filename"
            FILE_COUNT=$((FILE_COUNT + 1))
          done
          
          if [ -z "$LANGUAGES" ]; then
            LANGUAGES="$lang"
          else
            LANGUAGES="$LANGUAGES, $lang"
          fi
        done
        
        echo "files-downloaded=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "languages-updated=$LANGUAGES" >> $GITHUB_OUTPUT
        
        echo "Downloaded $FILE_COUNT files for languages: $LANGUAGES"

    - name: Commit changes
      if: inputs.commit-changes == 'true'
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        BRANCH: ${{ inputs.branch }}
        OUTPUT_DIR: ${{ inputs.output-dir }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add $OUTPUT_DIR
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No translation changes to commit"
        else
          # Fetch translation history to get co-authors
          echo "Fetching translation history for co-authoring..."
          
          HISTORY_RESPONSE=$(curl -sS -H "Authorization: Bearer $OIDC_TOKEN" \
            "$I18N_PLATFORM_URL/api/translations/history?projectId=$PROJECT_NAME&language=all&key=all" || echo '{"history":[]}')
          
          # Extract unique authors from history
          CO_AUTHORS=$(echo "$HISTORY_RESPONSE" | jq -r '
            .history[] 
            | select(.commitAuthor != null and .commitEmail != null) 
            | "Co-authored-by: \(.commitAuthor) <\(.commitEmail)>"
          ' | sort -u)
          
          # Build commit message with co-authors
          COMMIT_MSG="${{ inputs.commit-message }}"
          
          if [ -n "$CO_AUTHORS" ]; then
            echo "Adding co-authors to commit message:"
            echo "$CO_AUTHORS"
            COMMIT_MSG=$(cat <<EOF
${{ inputs.commit-message }}

$CO_AUTHORS
EOF
)
          fi
          
          # Create the commit with co-authors
          git commit -m "$COMMIT_MSG"
          git push
          echo "Translation changes committed and pushed with co-author attribution"
        fi
