name: 'Upload Translations to koro-i18n'
description: 'Upload translation files to koro-i18n platform with git blame'
branding:
  icon: 'upload-cloud'
  color: 'blue'

inputs:
  project-name:
    description: 'Project name on koro-i18n platform'
    required: true
  platform-url:
    description: 'Platform URL'
    required: false
    default: 'https://koro.f3liz.workers.dev'
  config-path:
    description: 'Path to .koro-i18n.repo.config.toml'
    required: false
    default: '.koro-i18n.repo.config.toml'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build koro-i18n client from repository
      shell: bash
      run: |
        # Navigate to the action's repository root
        ACTION_REPO_ROOT="${{ github.action_path }}/../../.."
        cd "$ACTION_REPO_ROOT/client-library"
        npm install
        npm run build
    
    - name: Get OIDC Token
      id: oidc
      shell: bash
      run: |
        # Request OIDC token with platform URL as audience
        OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ inputs.platform-url }}" | jq -r .value)
        echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT
    
    - name: Upload translations
      shell: bash
      run: |
        ACTION_REPO_ROOT="${{ github.action_path }}/../../.."
        node "$ACTION_REPO_ROOT/client-library/dist/cli.js" ${{ inputs.config-path }}
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ steps.oidc.outputs.token }}
