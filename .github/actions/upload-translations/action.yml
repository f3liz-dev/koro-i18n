name: 'Upload Translations to Koro i18n'
description: 'Process and upload translation files to Koro i18n platform'
author: 'Koro i18n'

branding:
  icon: 'globe'
  color: 'blue'

inputs:
  platform-url:
    description: 'The URL of the i18n platform'
    required: false
    default: 'https://koro.f3liz.workers.dev'
  project-name:
    description: 'Project name on the platform'
    required: true
  config-path:
    description: 'Path to .koro-i18n.repo.config.toml configuration file'
    required: true
    default: '.koro-i18n.repo.config.toml'
  mode:
    description: 'Upload mode: "structured" (default) or "json" for direct JSON upload'
    required: false
    default: 'structured'

outputs:
  files-uploaded:
    description: 'Number of files uploaded'
    value: ${{ steps.upload.outputs.files-uploaded }}
  upload-status:
    description: 'Status of the upload operation'
    value: ${{ steps.upload.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get OIDC Token
      id: oidc
      shell: bash
      run: |
        OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ inputs.platform-url }}" | jq -r .value)
        echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

    - name: Checkout koro-i18n client library
      uses: actions/checkout@v4
      with:
        repository: f3liz-dev/koro-i18n
        path: .koro-i18n-client
        sparse-checkout: |
          client-library
        sparse-checkout-cone-mode: false

    - name: Build and install i18n client
      shell: bash
      run: |
        cd .koro-i18n-client/client-library
        npm install
        npm run build
        npm link
        cd ../..

    - name: Upload translations (structured mode)
      if: inputs.mode == 'structured'
      id: upload-structured
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        i18n-upload --oidc-token "$OIDC_TOKEN" --project-name "$PROJECT_NAME" --config-path "${{ inputs.config-path }}" --platform-url "$I18N_PLATFORM_URL"
        echo "files-uploaded=0" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload translations (JSON mode)
      if: inputs.mode == 'json'
      id: upload-json
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        CONFIG_PATH: ${{ inputs.config-path }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        # Check if config file exists
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "Error: Config file not found at $CONFIG_PATH"
          echo "JSON mode requires .koro-i18n.repo.config.toml to be present"
          exit 1
        fi
        
        echo "Reading configuration from $CONFIG_PATH"
        
        # Extract sourceLanguage and includePatterns from config using a simple parser
        SOURCE_LANG=$(grep -E "^sourceLanguage" "$CONFIG_PATH" | sed -E 's/.*=\s*"([^"]+)".*/\1/')
        
        if [ -z "$SOURCE_LANG" ]; then
          echo "Error: Could not find sourceLanguage in config file"
          exit 1
        fi
        
        echo "Source language: $SOURCE_LANG"
        
        # Find all language directories in locales/
        echo "Scanning for languages in locales/ directory..."
        LANGUAGES=()
        if [ -d "locales" ]; then
          for lang_dir in locales/*/; do
            if [ -d "$lang_dir" ]; then
              lang=$(basename "$lang_dir")
              LANGUAGES+=("$lang")
              echo "  Found language: $lang"
            fi
          done
        fi
        
        if [ ${#LANGUAGES[@]} -eq 0 ]; then
          echo "Error: No language directories found in locales/"
          exit 1
        fi
        
        echo "Total languages found: ${#LANGUAGES[@]}"
        TOTAL_FILES_UPLOADED=0
        
        # Upload files for each language separately
        for lang in "${LANGUAGES[@]}"; do
          echo ""
          echo "Processing language: $lang"
          
          # Find all JSON files for this language
          FILES_JSON="{"
          FIRST=true
          FILE_COUNT=0
          
          # Find JSON files in the language directory
          if [ -d "locales/$lang" ]; then
            while IFS= read -r -d '' file; do
              if [ -f "$file" ]; then
                echo "  Processing file: $file"
                
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  FILES_JSON="$FILES_JSON,"
                fi
                
                FILENAME=$(basename "$file")
                CONTENT=$(cat "$file" | jq -c .)
                FILES_JSON="$FILES_JSON\"$FILENAME\":$CONTENT"
                FILE_COUNT=$((FILE_COUNT + 1))
              fi
            done < <(find "locales/$lang" -name "*.json" -type f -print0 2>/dev/null)
          fi
          
          FILES_JSON="$FILES_JSON}"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "  Warning: No JSON files found for language $lang"
            continue
          fi
          
          echo "  Found $FILE_COUNT files for language $lang"
          
          # Create a temporary file for the JSON payload
          TEMP_PAYLOAD=$(mktemp)
          echo "{\"branch\":\"$GITHUB_REF_NAME\",\"commitSha\":\"$GITHUB_SHA\",\"language\":\"$lang\",\"files\":$FILES_JSON}" > "$TEMP_PAYLOAD"
          
          # Upload to platform using OIDC token
          echo "  Uploading to platform..."
          RESPONSE=$(curl -s -X POST \
            "$I18N_PLATFORM_URL/api/projects/$PROJECT_NAME/upload-json" \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            -H "Content-Type: application/json" \
            --data-binary "@$TEMP_PAYLOAD")
          
          # Clean up temporary file
          rm -f "$TEMP_PAYLOAD"
          
          # Check if upload was successful
          if echo "$RESPONSE" | jq -e '.success' > /dev/null 2>&1; then
            UPLOADED=$(echo "$RESPONSE" | jq -r '.filesUploaded // 0')
            echo "  ✅ Successfully uploaded $UPLOADED files for $lang"
            TOTAL_FILES_UPLOADED=$((TOTAL_FILES_UPLOADED + UPLOADED))
          else
            echo "  ❌ Upload failed for $lang"
            echo "  Response: $RESPONSE"
          fi
        done
        
        echo ""
        echo "========================================="
        echo "Upload complete!"
        echo "Total files uploaded: $TOTAL_FILES_UPLOADED"
        echo "Languages processed: ${#LANGUAGES[@]}"
        echo "========================================="
        
        echo "files-uploaded=$TOTAL_FILES_UPLOADED" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Set upload outputs
      id: upload
      shell: bash
      run: |
        if [ "${{ inputs.mode }}" = "structured" ]; then
          echo "files-uploaded=${{ steps.upload-structured.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-structured.outputs.status }}" >> $GITHUB_OUTPUT
        else
          echo "files-uploaded=${{ steps.upload-json.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-json.outputs.status }}" >> $GITHUB_OUTPUT
        fi
