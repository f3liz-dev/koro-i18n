name: 'Upload Translations to Koro i18n'
description: 'Process and upload translation files to Koro i18n platform'
author: 'Koro i18n'

branding:
  icon: 'globe'
  color: 'blue'

inputs:
  platform-url:
    description: 'The URL of the i18n platform'
    required: false
    default: 'https://i18n-platform.workers.dev'
  api-key:
    description: 'API key for authentication with the platform'
    required: true
  project-name:
    description: 'Project name on the platform'
    required: true
  config-path:
    description: 'Path to .i18n-platform.toml configuration file'
    required: false
    default: '.i18n-platform.toml'
  mode:
    description: 'Upload mode: "structured" (default) or "json" for direct JSON upload'
    required: false
    default: 'structured'

outputs:
  files-uploaded:
    description: 'Number of files uploaded'
    value: ${{ steps.upload.outputs.files-uploaded }}
  upload-status:
    description: 'Status of the upload operation'
    value: ${{ steps.upload.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install i18n client
      shell: bash
      run: npm install -g @i18n-platform/client

    - name: Upload translations (structured mode)
      if: inputs.mode == 'structured'
      id: upload-structured
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        I18N_PLATFORM_API_KEY: ${{ inputs.api-key }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        i18n-upload
        echo "files-uploaded=0" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload translations (JSON mode)
      if: inputs.mode == 'json'
      id: upload-json
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        I18N_PLATFORM_API_KEY: ${{ inputs.api-key }}
        PROJECT_NAME: ${{ inputs.project-name }}
      run: |
        # Direct JSON upload using curl
        # Find all JSON files in locales directories
        FILES_JSON="{"
        FIRST=true
        
        for file in $(find locales -name "*.json" -o -name "*.json" | grep -E "locales/[a-z]{2}(-[A-Z]{2})?/"); do
          if [ "$FIRST" = true ]; then
            FIRST=false
          else
            FILES_JSON="$FILES_JSON,"
          fi
          
          FILENAME=$(basename "$file")
          CONTENT=$(cat "$file" | jq -c .)
          FILES_JSON="$FILES_JSON\"$FILENAME\":$CONTENT"
        done
        
        FILES_JSON="$FILES_JSON}"
        
        # Extract language from first locale directory found
        LANG=$(find locales -name "*.json" | head -1 | grep -oP "locales/\K[a-z]{2}(-[A-Z]{2})?" || echo "en")
        
        # Upload to platform
        RESPONSE=$(curl -X POST \
          "$I18N_PLATFORM_URL/api/projects/$PROJECT_NAME/upload-json" \
          -H "Authorization: Bearer $I18N_PLATFORM_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"branch\":\"$GITHUB_REF_NAME\",\"commitSha\":\"$GITHUB_SHA\",\"language\":\"$LANG\",\"files\":$FILES_JSON}")
        
        echo "Upload response: $RESPONSE"
        
        FILES_COUNT=$(echo "$RESPONSE" | jq -r '.filesUploaded // 0')
        echo "files-uploaded=$FILES_COUNT" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Set upload outputs
      id: upload
      shell: bash
      run: |
        if [ "${{ inputs.mode }}" = "structured" ]; then
          echo "files-uploaded=${{ steps.upload-structured.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-structured.outputs.status }}" >> $GITHUB_OUTPUT
        else
          echo "files-uploaded=${{ steps.upload-json.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-json.outputs.status }}" >> $GITHUB_OUTPUT
        fi
