name: 'Upload Translations to Koro i18n'
description: 'Process and upload translation files to Koro i18n platform'
author: 'Koro i18n'

branding:
  icon: 'globe'
  color: 'blue'

inputs:
  platform-url:
    description: 'The URL of the i18n platform'
    required: false
    default: 'https://koro.f3liz.workers.dev'
  project-name:
    description: 'Project name on the platform'
    required: true
  config-path:
    description: 'Path to .koro-i18n.repo.config.toml configuration file'
    required: true
    default: '.koro-i18n.repo.config.toml'
  mode:
    description: 'Upload mode: "structured" (default) or "json" for direct JSON upload'
    required: false
    default: 'structured'

outputs:
  files-uploaded:
    description: 'Number of files uploaded'
    value: ${{ steps.upload.outputs.files-uploaded }}
  upload-status:
    description: 'Status of the upload operation'
    value: ${{ steps.upload.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get OIDC Token
      id: oidc
      shell: bash
      run: |
        OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
          "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=${{ inputs.platform-url }}" | jq -r .value)
        echo "token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

    - name: Checkout koro-i18n client library
      uses: actions/checkout@v4
      with:
        repository: f3liz-dev/koro-i18n
        path: .koro-i18n-client
        sparse-checkout: |
          client-library
        sparse-checkout-cone-mode: false

    - name: Build and install i18n client
      shell: bash
      run: |
        cd .koro-i18n-client/client-library
        npm install
        npm run build
        npm link
        cd ../..

    - name: Upload translations (structured mode)
      if: inputs.mode == 'structured'
      id: upload-structured
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        i18n-upload --oidc-token "$OIDC_TOKEN"
        echo "files-uploaded=0" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload translations (JSON mode)
      if: inputs.mode == 'json'
      id: upload-json
      shell: bash
      env:
        I18N_PLATFORM_URL: ${{ inputs.platform-url }}
        OIDC_TOKEN: ${{ steps.oidc.outputs.token }}
        PROJECT_NAME: ${{ inputs.project-name }}
        CONFIG_PATH: ${{ inputs.config-path }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
      run: |
        # Check if config file exists
        if [ ! -f "$CONFIG_PATH" ]; then
          echo "Error: Config file not found at $CONFIG_PATH"
          echo "JSON mode requires .koro-i18n.repo.config.toml to be present"
          exit 1
        fi
        
        echo "Reading configuration from $CONFIG_PATH"
        
        # Extract sourceLanguage and includePatterns from config using a simple parser
        SOURCE_LANG=$(grep -E "^sourceLanguage" "$CONFIG_PATH" | sed -E 's/.*=\s*"([^"]+)".*/\1/')
        
        if [ -z "$SOURCE_LANG" ]; then
          echo "Error: Could not find sourceLanguage in config file"
          exit 1
        fi
        
        echo "Source language: $SOURCE_LANG"
        
        # Find all JSON files based on includePatterns (simplified for JSON mode)
        # We'll look for common patterns
        FILES_JSON="{"
        FIRST=true
        FILE_COUNT=0
        
        # Find JSON files - using a simpler approach that reads from config patterns
        for pattern in "locales/**/*.json" "src/locales/**/*.json" "translations/**/*.json"; do
          while IFS= read -r -d '' file; do
            # Skip if file doesn't exist or is in excluded paths
            if [[ ! -f "$file" ]] || [[ "$file" == *"/node_modules/"* ]] || [[ "$file" == *"/dist/"* ]]; then
              continue
            fi
            
            # Extract language from path
            LANG=$(echo "$file" | grep -oP '/[a-z]{2}(-[A-Z]{2})?/' | tr -d '/' || echo "")
            
            if [ -z "$LANG" ]; then
              continue
            fi
            
            echo "Processing file: $file (language: $LANG)"
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              FILES_JSON="$FILES_JSON,"
            fi
            
            FILENAME=$(basename "$file")
            CONTENT=$(cat "$file" | jq -c .)
            FILES_JSON="$FILES_JSON\"$FILENAME\":$CONTENT"
            FILE_COUNT=$((FILE_COUNT + 1))
          done < <(find . -path "*/$pattern" -type f -print0 2>/dev/null)
        done
        
        FILES_JSON="$FILES_JSON}"
        
        if [ $FILE_COUNT -eq 0 ]; then
          echo "Warning: No JSON files found matching patterns in config"
          echo "Please check includePatterns in $CONFIG_PATH"
        fi
        
        echo "Found $FILE_COUNT files to upload"
        
        # Upload to platform using OIDC token
        RESPONSE=$(curl -X POST \
          "$I18N_PLATFORM_URL/api/projects/$PROJECT_NAME/upload-json" \
          -H "Authorization: Bearer $OIDC_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"branch\":\"$GITHUB_REF_NAME\",\"commitSha\":\"$GITHUB_SHA\",\"language\":\"$SOURCE_LANG\",\"files\":$FILES_JSON}")
        
        echo "Upload response: $RESPONSE"
        
        UPLOAD_COUNT=$(echo "$RESPONSE" | jq -r '.filesUploaded // 0')
        echo "files-uploaded=$UPLOAD_COUNT" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Set upload outputs
      id: upload
      shell: bash
      run: |
        if [ "${{ inputs.mode }}" = "structured" ]; then
          echo "files-uploaded=${{ steps.upload-structured.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-structured.outputs.status }}" >> $GITHUB_OUTPUT
        else
          echo "files-uploaded=${{ steps.upload-json.outputs.files-uploaded }}" >> $GITHUB_OUTPUT
          echo "status=${{ steps.upload-json.outputs.status }}" >> $GITHUB_OUTPUT
        fi
