name: Documentation Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/architecture/**'
      - 'scripts/validate-docs.ps1'
      - 'scripts/build-docs.ps1'
      - '.github/workflows/docs-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/architecture/**'
      - 'scripts/validate-docs.ps1'
      - 'scripts/build-docs.ps1'
      - '.github/workflows/docs-validation.yml'

jobs:
  validate-docs:
    name: Validate Mathematical Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Typst
        run: |
          wget https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz
          tar -xf typst-x86_64-unknown-linux-musl.tar.xz
          sudo mv typst-x86_64-unknown-linux-musl/typst /usr/local/bin/
          typst --version
      
      - name: Validate documentation syntax
        run: |
          pwsh scripts/validate-docs.ps1 -Strict
      
      - name: Build documentation
        run: |
          pwsh scripts/build-docs.ps1 -Format all -Validate
      
      - name: Upload generated documentation
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-docs
          path: docs/generated/
          retention-days: 30
      
      - name: Check for outdated documentation
        run: |
          # Check if documentation was updated in the last 90 days
          for file in docs/architecture/*.typ; do
            last_modified=$(git log -1 --format="%at" -- "$file")
            current_time=$(date +%s)
            days_old=$(( (current_time - last_modified) / 86400 ))
            
            if [ $days_old -gt 90 ]; then
              echo "::warning file=$file::Documentation may be outdated (last modified $days_old days ago)"
            fi
          done
  
  build-docs-windows:
    name: Build Documentation (Windows)
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Typst
        run: |
          winget install --id Typst.Typst -e --silent
          typst --version
      
      - name: Build documentation
        run: |
          pwsh scripts/build-docs.ps1 -Format all -Validate
      
      - name: Upload generated documentation
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-docs-windows
          path: docs/generated/
          retention-days: 30
  
  build-docs-macos:
    name: Build Documentation (macOS)
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Typst
        run: |
          brew install typst
          typst --version
      
      - name: Build documentation
        run: |
          bash scripts/build-docs.sh --format all --validate
      
      - name: Upload generated documentation
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: generated-docs-macos
          path: docs/generated/
          retention-days: 30
