name: Generate Translation Logs

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  generate-logs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Export translation history from D1
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          mkdir -p public/logs
          
          # Export translation history as JSON
          wrangler d1 execute i18n-platform-db \
            --command="SELECT * FROM translation_history ORDER BY createdAt DESC" \
            --json > public/logs/history-raw.json
          
          # Process and format the history
          node -e "
          const fs = require('fs');
          const raw = JSON.parse(fs.readFileSync('public/logs/history-raw.json', 'utf8'));
          
          // Group by translation key
          const grouped = {};
          for (const entry of raw.results || []) {
            const key = \`\${entry.projectId}:\${entry.language}:\${entry.key}\`;
            if (!grouped[key]) {
              grouped[key] = {
                projectId: entry.projectId,
                language: entry.language,
                key: entry.key,
                history: []
              };
            }
            grouped[key].history.push({
              id: entry.translationId,
              value: entry.value,
              username: entry.username,
              action: entry.action,
              commitSha: entry.commitSha,
              createdAt: entry.createdAt
            });
          }
          
          fs.writeFileSync('public/logs/history.json', JSON.stringify(grouped, null, 2));
          
          // Generate summary
          const summary = {
            generated_at: new Date().toISOString(),
            total_translations: Object.keys(grouped).length,
            total_actions: raw.results?.length || 0,
            actions_by_type: {}
          };
          
          for (const entry of raw.results || []) {
            summary.actions_by_type[entry.action] = (summary.actions_by_type[entry.action] || 0) + 1;
          }
          
          fs.writeFileSync('public/logs/summary.json', JSON.stringify(summary, null, 2));
          "
      
      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: translation-logs
          path: public/logs/
          retention-days: 90
      
      - name: Commit and push logs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/logs/
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: Update translation logs [skip ci]" && git push)
