# Generate koro-i18n Metadata Workflow
#
# This workflow generates the .koro-i18n/koro-i18n.repo.generated.json metadata file
# which enables using the GitHub repository as a realtime source for translations on web.
#
# Setup:
# 1. Copy this workflow to your repository's .github/workflows/ directory
# 2. Ensure you have a .koro-i18n.repo.config.toml file in your repository root
# 3. Configure the config file with your project settings
#
# The generated metadata file allows the koro-i18n platform to fetch translations
# directly from your GitHub repository without requiring manual uploads.

name: Generate koro-i18n Metadata

on:
  push:
    branches:
      - main
    paths:
      # Regenerate when translation files change
      - 'locales/**'
      - '.koro-i18n.repo.config.toml'

  workflow_dispatch:
    inputs:
      force:
        description: 'Force regeneration of metadata'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to commit the generated metadata file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git blame and commit tracking

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for config file
        id: check-config
        run: |
          if [ -f ".koro-i18n.repo.config.toml" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "✓ Found .koro-i18n.repo.config.toml"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "⚠ No .koro-i18n.repo.config.toml found"
          fi

      - name: Install koro-i18n client
        if: steps.check-config.outputs.config_exists == 'true'
        run: |
          # Clone the koro-i18n repository to get the client library
          git clone --depth 1 https://github.com/f3liz-dev/koro-i18n.git /tmp/koro-i18n
          cd /tmp/koro-i18n/client-library
          npm install
          npm run build
          echo "✓ koro-i18n client installed and built"

      - name: Generate metadata
        if: steps.check-config.outputs.config_exists == 'true'
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Run the koro-i18n client to generate metadata
          node /tmp/koro-i18n/client-library/dist/cli.js .koro-i18n.repo.config.toml
          echo "✓ Metadata generated"

      - name: Commit and push metadata
        if: steps.check-config.outputs.config_exists == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if .koro-i18n directory exists and has the generated file
          if [ -f ".koro-i18n/koro-i18n.repo.generated.json" ]; then
            git add .koro-i18n/koro-i18n.repo.generated.json

            # Check if there are changes to commit
            if git diff --staged --quiet; then
              echo "ℹ No changes to commit - metadata is up to date"
            else
              git commit -m "chore: Update koro-i18n metadata [skip ci]"
              git push
              echo "✓ Metadata committed and pushed"
            fi
          else
            echo "⚠ No metadata file generated"
            exit 1
          fi
